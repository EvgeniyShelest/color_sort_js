<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ice cube sort (table edition)</title>
  <style>
    body {
      padding: 20px 0;
      text-align: center;
      color: #3366CC;
      font-size: 2rem;
    }
    #field table {
      margin: 20px auto;
      background-color: #3366CC;
      border-spacing: 3px;
    }
    #field table td {
      background-color: #ffffff;
      text-align: center;
      vertical-align: middle;
      height: 100px;
      width: 100px;
    }
    #field table td.empty {
      background-color: #3366CC;
    }
    @media screen and (max-width: 768px) {
      body {
        font-size: 1.5rem;
      }
      #field table {
        border-spacing: 2px;
      }
      #field table td {
        height: 10vmin;
        width: 10vmin;
      }
      #describe::after {
        content: "\a";
        white-space: pre;
      }
    }
  </style>
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script>
    $(document).ready(function () {
      const game = {
        flask_amount: 6,
        flask_capacity: 4,
        moveFromFlaskId: null,
        stepCounter: 0,
        field: [],
        isEmptyFlask: function (flaskId) { return this.field[flaskId].every(el => el === 0) },
        isMonofilledFlask: function (flask) { return flask.slice(1,).every(el => el === flask[0]) },
        lastNonZeroElFromFlask: function (flaskId) {
          const nonZero = (element) => element !== 0;
          return this.field[flaskId].findLast(nonZero);
         },
        firstEmptyIndexFromFlask: function (flaskId) {
          const isZero = (element) => element === 0;
          return this.field[flaskId].findIndex(isZero);
         },
        isFitableToMoveTo: function (flaskId, el) {
          return this.isEmptyFlask(flaskId) || (new RegExp(`(,${el})+(,0)+$`)).test("," + this.field[flaskId].join())
        },
        addEmptyFlask: function () { this.field.push(new Array(this.flask_capacity).fill(0)) },
        init: function () {
          this.createField();
          this.drawField();
          this.bindHandlers();
        },
        createField: function () {
          const arrStart = Array.apply(0, { length: this.flask_amount })
                              .map((x, y) => { // Use => here, because function(x,y) changes `this` inside
                                return new Array(this.flask_capacity).fill(y+1)
                              });
          const shuffle = function (o) {
            for (let j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
            return o;
          };
          const shuffledArr = shuffle(arrStart.flat());
          for (let i = 0; i < this.flask_amount; i++) {
            this.field[i] = [];
            for (let j = 0; j < this.flask_capacity; j++) {
              this.field[i][j] = shuffledArr[i * this.flask_capacity + j];
            }
          }
          // this.field = [[9, 10, 6, 1], [13, 2, 12, 4], [12, 1, 8, 2], [7, 4, 8, 9], [13, 7, 5, 2], [13, 12, 6, 2], [13, 11, 6, 10], [13, 11, 3, 4], [1, 11, 5, 5], [10, 8, 7, 3], [13, 9, 1, 6], [5, 3, 7, 4]];
          this.addEmptyFlask();
          this.addEmptyFlask();
        },
        drawField: function () {
          let htmlString = '<table>';
          for (let i = this.flask_capacity - 1; i >= 0; i--) {
            htmlString += '<tr>';
            for (let j = 0; j < this.field.length; j++) {
              let isEmpty = this.field[j][i] == 0 ? ' class=empty' : '';
              htmlString += "<td id=" + [j, i].join('-') + isEmpty + ">" +
                  this.field[j][i] + "</td>";
            };
            htmlString += '</tr>';
          };
          htmlString += '</table>';
          $('#field').html(htmlString);
        },
        bindHandlers: function () {
          $('#field td').on('click', function () {
            let id = $(this).attr('id').split('-');
            console.log(Number(id[0]), Number(id[1]));
            let flaskId = Number(id[0]);
            if (game.moveFromFlaskId == null) {
              if (game.isEmptyFlask(flaskId)) { console.log("Empty"); return; }
              game.moveFromFlaskId = flaskId;
            } else {
              if (flaskId === game.moveFromFlaskId) { console.log("The same flask"); return; }
              game.doMove(game.moveFromFlaskId, flaskId);
              game.moveFromFlaskId = null;
            }
          });
        },
        unbindHandlers: function () {
          $('#field td').unbind("click");
        },
        doMove: function (fromFlaskId, toFlaskId) {
          console.log("doMove", fromFlaskId, toFlaskId);
          let el = this.lastNonZeroElFromFlask(fromFlaskId);
          console.log("el:", el);
          if (!this.isFitableToMoveTo(toFlaskId, el)) {
            console.log("Unfitable");
            return;
          }
          indexFrom = this.field[fromFlaskId].findLastIndex(e => el === e);
          indexTo = this.firstEmptyIndexFromFlask(toFlaskId);
          this.field[fromFlaskId][indexFrom] = 0;
          this.field[toFlaskId][indexTo] = el;
          $('td#' + toFlaskId  + '-' + indexTo).removeClass('empty').text(el);
          $('td#' + fromFlaskId + '-' + indexFrom).addClass('empty').text(0);
          game.stepCounter += 1;
          $('#feedback').text('step:' + game.stepCounter);

          if (el === this.lastNonZeroElFromFlask(fromFlaskId)) this.doMove(fromFlaskId, toFlaskId);

          if(this.isFinish()) {
            $('#feedback').text('Finished on step ' + game.stepCounter);
            this.unbindHandlers();
          };
        },
        isFinish: function () {
          return this.field.every(flask => this.isMonofilledFlask(flask));
        }
      };
      game.init();
    });
  </script>
</head>
<body>
  <span id='describe'>Sort numered ice cubes.</span>
  <span>Each number in separate column.</span>
<div id='field'></div>
<div id='feedback'></div>
</body>
</html>
